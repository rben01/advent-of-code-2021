<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport"
	content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Day 22: Reactor Reboot :: Robert Bennett — Advent of Code 2021</title>
        <link rel="prev" href="../day_21/soln">
        <link rel="next" href="../day_23/soln">
    <meta name="generator" content="Antora 3.1.2">
<link rel="stylesheet" href="../../_/css/site.css" />
<link rel="stylesheet" href="../../_/css/code-syntax-highlight.css" />
<link rel="stylesheet" href="https://use.typekit.net/fnd4xvj.css" />
<link rel="stylesheet" href="https://iosevka-rltb.pages.dev/dist/iosevka-rltb-mono/iosevka-rltb-mono-cloudflare.css">
<meta name="theme-color" content="#0970c4" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#0967b4" media="(prefers-color-scheme: dark)">
<script>var uiRootPath = '../../_';</script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
		integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
	<!-- The loading of KaTeX is deferred to speed up page rendering -->
	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
		integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
		crossorigin="anonymous"></script>
	<!-- To automatically render math in text elements, include the auto-render extension: -->
	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
		integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
		onload="renderMathInElement(document.body);"></script>
<link rel="icon" type="image/x-icon" href="../../favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
</head>

<body class="article">
  <header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">Robert Bennett — Advent of Code 2021</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable open-left">
          <span class="navbar-link">Links</span>
          <div class="navbar-dropdown">
            <a class="navbar-item navbar-external-link" href="https://github.com/rben01" target="_blank">
              <div class="site-logo github-logo github-repo-logo"></div><span class="site-url">/&nbsp;rben01</span>
            </a>
          </div>
        </div>
          <div class="navbar-item search hide-for-print">
            <div id="search-field" class="field">
              <input id="search-input" type="text" placeholder="Search this site">
            </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<svg xmlns="http://www.w3.org/2000/svg" id="icon-mask-container" width="0" height="0">
	<defs>
		<clipPath id="icon-github" clipPathUnits="objectBoundingBox">
			<path transform="scale(0.0102040816)" fill-rule="evenodd" clip-rule="evenodd"
				d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z">
			</path>
		</clipPath>
		<clipPath id="icon-menu-clippath" clipPathUnits="objectBoundingBox">
			<circle cx=".1" cy=".1575" r=".06"></circle>
			<path d="M.325 .1175h.65 v.08h-.65z"></path>
			<circle cx=".25" cy=".4775" r=".06"></circle>
			<path d="M.475 .4375h.5 v.08h-.5z"></path>
			<circle cx=".25" cy=".7975" r=".06"></circle>
			<path d="M.475 .7575h.5 v.08h-.5z"></path>
		</clipPath>
		<clipPath id="icon-external-link" clipPathUnits="objectBoundingBox">
			<path transform="translate(.5 .5) scale(0.0017) translate(-256 -256)"
				d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32H320zM80 32C35.8 32 0 67.8 0 112V432c0 44.2 35.8 80 80 80H400c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32V432c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H192c17.7 0 32-14.3 32-32s-14.3-32-32-32H80z" />
		</clipPath>
		<clipPath id="icon-star" clipPathUnits="objectBoundingBox">
			<path transform="translate(.5 .5) scale(0.001736) translate(-288 -256)"
				d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z" />
		</clipPath>
		<clipPath id="icon-admon-caution" clipPathUnits="objectBoundingBox">
			<path transform="translate(.5 .5) scale(0.001953125) translate(-224 -256)" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7
			.1c27.6 25.9 53.5 53.8 77.7 84c11-14.4 23.5-30.1 37-42.9c7.9-7.4 20.1-7.4 28 .1c34.6 33 63.9 76.6 84.5 118c20.3
			40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512C98.4 512 0 404.1 0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3
			97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3 0 47.7-7 68.8-21c42.1-29.4 53.4-88.2
			28.1-134.4c-4.5-9-16-9.6-22.5-2l-25.2 29.3c-6.6 7.6-18.5
			7.4-24.7-.5c-16.5-21-46-58.5-62.8-79.8c-6.3-8-18.3-8.1-24.7-.1c-33.8 42.5-50.8 69.3-50.8 99.4C112 375.4 162.6
			416 225.7 416z" />
		</clipPath>
		<clipPath id="icon-admon-important" clipPathUnits="objectBoundingBox">
			<path transform="translate(.5 .5) scale(0.001753125) translate(-256 -256)"
				d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z" />
		</clipPath>
		<clipPath id="icon-admon-note" clipPathUnits="objectBoundingBox">
			<path transform="translate(.5 .5) scale(0.001753125) translate(-256 -256)"
				d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z" />
		</clipPath>
		<clipPath id="icon-admon-tip" clipPathUnits="objectBoundingBox">
			<path transform="translate(.5 .5) scale(0.001953125) translate(-192 -256)"
				d="M256 384c9.6-31.9 29.5-59.1 49.2-86.2l0 0c5.2-7.1 10.4-14.2 15.4-21.4c19.8-28.5 31.4-63 31.4-100.3C352 78.8 273.2 0 176 0S0 78.8 0 176c0 37.3 11.6 71.9 31.4 100.3c5 7.2 10.2 14.3 15.4 21.4l0 0C66.5 324.9 86.4 352.1 96 384H256zM176 512c44.2 0 80-35.8 80-80V416H96v16c0 44.2 35.8 80 80 80zM96 176c0 8.8-7.2 16-16 16s-16-7.2-16-16c0-61.9 50.1-112 112-112c8.8 0 16 7.2 16 16s-7.2 16-16 16c-44.2 0-80 35.8-80 80z" />
		</clipPath>
		<clipPath id="icon-admon-warning" clipPathUnits="objectBoundingBox">
			<path transform="translate(.5 .5) scale(0.001953125) translate(-256 -256)"
				d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z" />
		</clipPath>
	</defs>
	<symbol viewBox="0 0 100 100" id="icon-back" class="svg-icon-template">
		<path
			d="m 50.000978,9.89975 -40.1010516,40.10025 40.1010516,40.10025 5.6556,-5.65551 -30.434757,-30.44194 h 64.878253 v -8.0056 H 25.221821 l 30.434757,-30.44001 z" />
	</symbol>
	<symbol viewBox="0 0 30 30" id="icon-caret" class="svg-icon-template">
		<path d="m 10.18745,2.9998 14.0001,12.0002 -14.0001,12.0001 z" stroke-width="2" stroke-linecap="round"
			stroke-linejoin="round" />
	</symbol>
	<symbol viewBox="0 0 30 30" id="icon-chevron">
		<path
			d="M 3.6699219,6.5898438 1.4550781,8.6152344 15,23.374272 28.544922,8.6152344 26.330078,6.5898438 15,18.759498 Z" />
	</symbol>
	<symbol viewBox="0 0 16 16" id="icon-clipboard">
		<path fill-rule="evenodd"
			d="M5.75 1a.75.75 0 00-.75.75v3c0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75v-3a.75.75 0 00-.75-.75h-4.5zm.75 3V2.5h3V4h-3zm-2.874-.467a.75.75 0 00-.752-1.298A1.75 1.75 0 002 3.75v9.5c0 .966.784 1.75 1.75 1.75h8.5A1.75 1.75 0 0014 13.25v-9.5a1.75 1.75 0 00-.874-1.515.75.75 0 10-.752 1.298.25.25 0 01.126.217v9.5a.25.25 0 01-.25.25h-8.5a.25.25 0 01-.25-.25v-9.5a.25.25 0 01.126-.217z" />
	</symbol>
	<symbol viewBox="0 0 1 1" id="icon-home-filled" class="svg-icon-template icon-home">
		<path
			d="M.5002 .10747572875253811 L.10042786437626905 .4662178643762691 l.02671524585077328 .029770717813528465 l.06725688977295768 -.060354082044552726 v.44845 h.25506 v-.25166 H.5505 v.25166 h.25506 v-.44845 l.06725688977295768 .060354082044552726 l.02671524585077328 -.029770717813528465 l-.154812135623731 -.13892322952293115 V.1 h-.12657 V.21371495268001076 z" />
	</symbol>
	<symbol viewBox="0 0 1 1" id="icon-home-outline" class="svg-icon-template icon-home">
		<path
			d="M.5002 .10747572875253811 L.10042786437626905 .4662178643762691 l.02671524585077328 .029770717813528465 l.06725688977295768 -.060354082044552726 v.44845 h.25506 v-.25166 H.5505 v.25166 h.25506 v-.44845 l.06725688977295768 .060354082044552726 l.02671524585077328 -.029770717813528465 l-.154812135623731 -.13892322952293115 V.1 h-.12657 V.21371495268001076 z v.0565685424949238 L.65815 .30578331524901864 V.14 H.70472 V.2910051322295775 L.65815 .2492147727540948 v.0565685424949238 L.76556 .40216945463621206 V.8440845001452447 h-.17166 v-.25166 H.40946 v.25166 h-.17166 V.40216945463621206 L.5002 .16404427124746193 z " />
	</symbol>
	<symbol viewBox="0 0 1 1" id="icon-menu">
		<circle cx=".1" cy=".1575" r=".06"></circle>
		<path d="M.325 .1175h.65 v.08h-.65z"></path>
		<circle cx=".25" cy=".4775" r=".06"></circle>
		<path d="M.475 .4375h.5 v.08h-.5z"></path>
		<circle cx=".25" cy=".7975" r=".06"></circle>
		<path d="M.475 .7575h.5 v.08h-.5z"></path>
	</symbol>
</svg>
  <div class="body">
	<div class="nav-container"  data-component="ROOT"
  data-version="" >
  <aside class="nav">
    <div class="panels">
      <div class="nav-panel-explore is-active" data-panel="explore">
  <div class="context">
    <span class="title">Navigation</span>
    <span class="nav-explore-expander">
      <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon" viewBox="0 0 1 1">
        <title>Discloure chevron</title>
        <use href="#icon-chevron"></use>
      </svg>
    </span>
  </div>
  <ul class="components">
      <li
        class="component is-current">
          <a class="title" href="../../">Solutions</a>
            <ul class="nav-list">
      <li class="nav-item is-active"
        data-depth="0">
        <span
          class="nav-item-expander clickable">
        </span>
          <ul class="nav-list">
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_01/soln">Day 1: Sonar Sweep</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_02/soln">Day 2: Dive!</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_03/soln">Day 3: Binary Diagnostic</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_04/soln">Day 4: Giant Squid</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_05/soln">Day 5: Hydrothermal Venture</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_06/soln">Day 6: Lanternfish</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_07/soln">Day 7: The Treachery of Whales</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_08/soln">Day 8: Seven Segment Search</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_09/soln">Day 9: Smoke Basin</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_10/soln">Day 10: Syntax Scoring</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_11/soln">Day 11: Dumbo Octopus</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_12/soln">Day 12: Passage Pathing</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_13/soln">Day 13: Transparent Origami</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_14/soln">Day 14: Extended Polymerization</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_15/soln">Day 15: Chiton</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_16/soln">Day 16: Packet Decoder</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_17/soln">Day 17: Trick Shot</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_18/soln">Day 18: Snailfish</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_19/soln">Day 19: Beacon Scanner</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_20/soln">Day 20: Trench Map</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_21/soln">Day 21: Dirac Dice</a>
        </span>
              </li>
      <li class="nav-item is-active is-current-page"
        data-depth="1">
        <span
          class="nav-item-expander final-depth">
              <span class="nav-text">Day 22: Reactor Reboot</span>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_23/soln">Day 23: Amphipod</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_24/soln">Day 24: Arithmetic Logic Unit</a>
        </span>
              </li>
      <li class="nav-item is-active"
        data-depth="1">
        <span
          class="nav-item-expander clickable final-depth">
              <a class="nav-link"
                href="../day_25/soln">Day 25: Sea Cucumber</a>
        </span>
              </li>
  </ul>
      </li>
  </ul>
      </li>
  </ul>
</div>
    </div>
  </aside>
</div>
	<main class="article">
  <div class="toolbar" role="navigation">
  <button class="nav-toggle">
	<svg class="svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1 1">
		<title>Show or hide menu</title>
		<use class="icon-menu" href="#icon-menu"></use>
		<use class="icon-back" href="#icon-back"></use>
	</svg>
</button>
    <a href="../../" class="home-link" title="Home">
      <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon icon-home" viewBox="0 0 1 1">
        <title>Home</title>
        <use class="icon-home icon-home-filled" href="#icon-home-filled"></use>
        <use class="icon-home icon-home-outline" href="#icon-home-outline"></use>
      </svg>
    </a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li>&#47;</li> 
          <li>
              <a href="../../">Solutions</a>

          </li>
        <li>&#47;</li>
        <li><a href="#">Day 22: Reactor Reboot</a></li>
    </ul>
</nav>
  </div>
  <div class="content">
      <aside class="toc sidebar" data-title="Contents"
  data-levels="2">
  <div class="toc-menu"></div>
</aside>
      <article class="doc">
	<div class="title-container">
			<h1 class="page">Day 22: Reactor Reboot</h1>
	</div>
	<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://adventofcode.com/2021/day/22" target="^"><span class="icon"><i class="fa fa-star-half-o"></i></span> Day #22 problem description</a> │ <a href="/_attachments/src/day_22/input.txt" target="^"><span class="icon"><i class="fa fa-file-text-o"></i></span> Problem input</a></p>
</div>
<div class="paragraph">
<p>This problem asks us to find the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1\times1\times1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> cubes — “small cubes” — in 3D space that remain after sequentially turning on and turning off the small cubes contained in a sequence of upright 3D rectangular prisms with integer coordinates; we&#8217;ll refer to these prisms as “boxes”.
We record which small cubes remain after each operation as a list of boxes containing those cubes; the question is then how to record the boxes that result after performing the sequence of additions and subtractions between boxes.
In other words, if at stage <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>  the “on” cubes are contained in boxes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>B</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">B_1,\ldots,B_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, and we switch off the small cubes in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">B_{n+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span>, what set of boxes now contains the remaining “on” cubes?
For simplicity, we&#8217;ll refer to the process of turning on the small cubes in a box <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> as “adding” <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, and turning off the cubes in <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> as “subtracting” <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>.</p>
</div>
<div class="paragraph">
<p>To subtract a single box <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> from another box <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, we first note that we only need to subtract the intersection <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>3</mn></msub><mo><mi mathvariant="normal">≔</mi></mo><msub><mi>B</mi><mn>1</mn></msub><mo>∩</mo><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">B_3\coloneqq B_1\cap B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mop" style="position:relative;top:-0.0347em;">:</span></span><span class="mrel"><span class="mspace" style="margin-right:-0.0667em;"></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> of the two boxes from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.
Then, to subtract <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">B_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, we note that each maximal set of parallel edges of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">B_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> divides the corresponding axis of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> into three (potentially empty) regions: the parts before, between, and after their endpoints.
For instance, if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">B_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> has edge <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">( (x_1,y,z) , (x_2,y,z) )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">))</span></span></span></span> with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_1&lt;x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, then this edge divides <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> into three portions along the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>-axis: the parts less than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, between <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, and greater than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.
Since each of the three axes is split into three regions by the subtraction, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">B_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ultimately divides <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> into 27 smaller (but not necessarily “small”) boxes, exactly one of which is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">B_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> itself.
Hence <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub><mo>−</mo><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">B_1-B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is just the list containing the other 26 boxes.</p>
</div>
<div class="paragraph">
<p>To subtract a single cube from the list of cubes <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>B</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">B_1,\ldots,B_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, we simply subtract it from each <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">B_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> in turn, then collect all the resulting smaller boxes into a single list.
Hence, to improve performance, after each subtraction, we (greedily) recombine the 26 smaller boxes into as few larger boxes as possible; otherwise the list of boxes to subtract from would grow without bound.
To recombine boxes, we simply take two boxes that have a face in common and write them as the union, and repeat this until no two boxes share a face.
(Fewer boxes could probably be obtained with some sort of dynamic programming algorithm; this wasn&#8217;t deemed worth it.)</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_setup"><a class="anchor" href="#_setup"></a>Setup</h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-rust" data-lang="rust"><span class="hljs-comment">// tag::setup[]</span>
<span class="hljs-keyword">use</span> crate::Answer;
<span class="hljs-keyword">use</span> std::fmt::{Display, Write};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Span</span> = [<span class="hljs-type">i32</span>; <span class="hljs-number">2</span>];

<span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cuboid</span> {
	x_range: Span,
	y_range: Span,
	z_range: Span,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">size</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
		<span class="hljs-keyword">fn</span> <span class="hljs-title function_">width</span>(span: Span) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
			<span class="hljs-type">usize</span>::<span class="hljs-title function_ invoke__">try_from</span>(span[<span class="hljs-number">1</span>] - span[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>()
		}
		<span class="hljs-keyword">let</span> &amp;Cuboid {
			x_range,
			y_range,
			z_range,
		} = <span class="hljs-keyword">self</span>;

		<span class="hljs-title function_ invoke__">width</span>(x_range) * <span class="hljs-title function_ invoke__">width</span>(y_range) * <span class="hljs-title function_ invoke__">width</span>(z_range)
	}
}

<span class="hljs-comment">// tag::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">std</span>::fmt::Display <span class="hljs-keyword">for</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">fmt</span>(&amp;<span class="hljs-keyword">self</span>, f: &amp;<span class="hljs-keyword">mut</span> std::fmt::Formatter&lt;<span class="hljs-symbol">&#x27;_</span>&gt;) <span class="hljs-punctuation">-&gt;</span> std::fmt::<span class="hljs-type">Result</span> {
		<span class="hljs-keyword">let</span> [x0, x1] = &amp;<span class="hljs-keyword">self</span>.x_range;
		<span class="hljs-keyword">let</span> [y0, y1] = &amp;<span class="hljs-keyword">self</span>.y_range;
		<span class="hljs-keyword">let</span> [z0, z1] = &amp;<span class="hljs-keyword">self</span>.z_range;
		<span class="hljs-built_in">write!</span>(f, <span class="hljs-string">&quot;{:?}-{:?},{:?}-{:?},{:?}-{:?}&quot;</span>, x0, x1, y0, y1, z0, z1)
	}
}

<span class="hljs-comment">// end::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">intersection</span>(&amp;<span class="hljs-keyword">self</span>, other: &amp;<span class="hljs-keyword">Self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">fn</span> <span class="hljs-title function_">span_intersection</span>(span1: Span, span2: Span) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Span&gt; {
			<span class="hljs-keyword">let</span> <span class="hljs-variable">lower</span> = span1[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">max</span>(span2[<span class="hljs-number">0</span>]);
			<span class="hljs-keyword">let</span> <span class="hljs-variable">upper</span> = span1[<span class="hljs-number">1</span>].<span class="hljs-title function_ invoke__">min</span>(span2[<span class="hljs-number">1</span>]);
			<span class="hljs-keyword">if</span> upper &lt; lower {
				<span class="hljs-literal">None</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-title function_ invoke__">Some</span>([lower, upper])
			}
		}

		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">Self</span> {
			x_range: <span class="hljs-title function_ invoke__">span_intersection</span>(<span class="hljs-keyword">self</span>.x_range, other.x_range)?,
			y_range: <span class="hljs-title function_ invoke__">span_intersection</span>(<span class="hljs-keyword">self</span>.y_range, other.y_range)?,
			z_range: <span class="hljs-title function_ invoke__">span_intersection</span>(<span class="hljs-keyword">self</span>.z_range, other.z_range)?,
		})
	}

	<span class="hljs-comment">/// `other` divides `self` into 3^3 = 27 (potentially empty) sub-cuboids. Of the 26</span>
	<span class="hljs-comment">/// that aren&#x27;t `other`, we keep the nonempty ones. Once we&#x27;ve found them, we merge</span>
	<span class="hljs-comment">/// them into as large cuboids as possible.</span>
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">difference</span>(&amp;<span class="hljs-keyword">self</span>, other: &amp;<span class="hljs-keyword">Self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_spans</span>(my_span: Span, intersection_span: Span) <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">Option</span>&lt;Span&gt;; <span class="hljs-number">3</span>] {
			<span class="hljs-keyword">let</span> <span class="hljs-variable">span1</span> = <span class="hljs-keyword">if</span> my_span[<span class="hljs-number">0</span>] == intersection_span[<span class="hljs-number">0</span>] {
				<span class="hljs-literal">None</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-title function_ invoke__">Some</span>([my_span[<span class="hljs-number">0</span>], intersection_span[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>])
			};

			<span class="hljs-keyword">let</span> <span class="hljs-variable">span2</span> = <span class="hljs-title function_ invoke__">Some</span>(intersection_span);

			<span class="hljs-keyword">let</span> <span class="hljs-variable">span3</span> = <span class="hljs-keyword">if</span> intersection_span[<span class="hljs-number">1</span>] == my_span[<span class="hljs-number">1</span>] {
				<span class="hljs-literal">None</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-title function_ invoke__">Some</span>([intersection_span[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>, my_span[<span class="hljs-number">1</span>]])
			};

			[span1, span2, span3]
		}

		<span class="hljs-keyword">let</span> <span class="hljs-variable">intersection</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">intersection</span>(other) {
			<span class="hljs-title function_ invoke__">Some</span>(c) =&gt; c,
			<span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec!</span>[*<span class="hljs-keyword">self</span>],
		};

		<span class="hljs-keyword">let</span> <span class="hljs-variable">x_ranges</span> = <span class="hljs-title function_ invoke__">get_spans</span>(<span class="hljs-keyword">self</span>.x_range, intersection.x_range);
		<span class="hljs-keyword">let</span> <span class="hljs-variable">y_ranges</span> = <span class="hljs-title function_ invoke__">get_spans</span>(<span class="hljs-keyword">self</span>.y_range, intersection.y_range);
		<span class="hljs-keyword">let</span> <span class="hljs-variable">z_ranges</span> = <span class="hljs-title function_ invoke__">get_spans</span>(<span class="hljs-keyword">self</span>.z_range, intersection.z_range);

		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">on_cuboids</span> = <span class="hljs-type">Vec</span>::&lt;<span class="hljs-keyword">Self</span>&gt;::<span class="hljs-title function_ invoke__">new</span>();
		<span class="hljs-keyword">for</span> &amp;x_range <span class="hljs-keyword">in</span> x_ranges.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">flatten</span>() {
			<span class="hljs-keyword">for</span> &amp;y_range <span class="hljs-keyword">in</span> y_ranges.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">flatten</span>() {
				<span class="hljs-keyword">for</span> &amp;z_range <span class="hljs-keyword">in</span> z_ranges.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">flatten</span>() {
					<span class="hljs-keyword">if</span> x_range != intersection.x_range
						|| y_range != intersection.y_range
						|| z_range != intersection.z_range
					{
						on_cuboids.<span class="hljs-title function_ invoke__">push</span>(Cuboid {
							x_range,
							y_range,
							z_range,
						});
					}
				}
			}
		}

		<span class="hljs-comment">// Iteratively merge the split-up cuboids together, where possible. For instance,</span>
		<span class="hljs-comment">// if the middle of a cuboid was removed, there are 26 small cuboids created, but they</span>
		<span class="hljs-comment">// can be merged into six larger cuboids. This is done by looking for abutting</span>
		<span class="hljs-comment">// cuboids with the same dimensions along their respective abutting faces and</span>
		<span class="hljs-comment">// combining them into one cuboid.</span>
		<span class="hljs-symbol">&#x27;merge</span>: <span class="hljs-keyword">loop</span> {
			<span class="hljs-title function_ invoke__">for</span> (
				i,
				&amp;c1 @ Cuboid {
					x_range,
					y_range,
					z_range,
				},
			) <span class="hljs-keyword">in</span> on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>()
			{
				<span class="hljs-title function_ invoke__">for</span> (j, &amp;c2) <span class="hljs-keyword">in</span> on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>().<span class="hljs-title function_ invoke__">skip</span>(i + <span class="hljs-number">1</span>) {
					<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cs</span> = [c1, c2];
					<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merged_cuboid</span> = <span class="hljs-literal">None</span>;
					<span class="hljs-keyword">if</span> y_range == c2.y_range &amp;&amp; z_range == c2.z_range {
						cs.<span class="hljs-title function_ invoke__">sort_by_key</span>(|c| c.x_range);
						<span class="hljs-keyword">if</span> cs[<span class="hljs-number">0</span>].x_range[<span class="hljs-number">1</span>] == cs[<span class="hljs-number">1</span>].x_range[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span> {
							merged_cuboid = <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
								x_range: [cs[<span class="hljs-number">0</span>].x_range[<span class="hljs-number">0</span>], cs[<span class="hljs-number">1</span>].x_range[<span class="hljs-number">1</span>]],
								y_range,
								z_range,
							});
						}
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> x_range == c2.x_range &amp;&amp; z_range == c2.z_range {
						cs.<span class="hljs-title function_ invoke__">sort_by_key</span>(|c| c.y_range);
						<span class="hljs-keyword">if</span> cs[<span class="hljs-number">0</span>].y_range[<span class="hljs-number">1</span>] == cs[<span class="hljs-number">1</span>].y_range[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span> {
							merged_cuboid = <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
								x_range,
								y_range: [cs[<span class="hljs-number">0</span>].y_range[<span class="hljs-number">0</span>], cs[<span class="hljs-number">1</span>].y_range[<span class="hljs-number">1</span>]],
								z_range,
							});
						}
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> x_range == c2.x_range &amp;&amp; y_range == c2.y_range {
						cs.<span class="hljs-title function_ invoke__">sort_by_key</span>(|c| c.z_range);
						<span class="hljs-keyword">if</span> cs[<span class="hljs-number">0</span>].z_range[<span class="hljs-number">1</span>] == cs[<span class="hljs-number">1</span>].z_range[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span> {
							merged_cuboid = <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
								x_range,
								y_range,
								z_range: [cs[<span class="hljs-number">0</span>].z_range[<span class="hljs-number">0</span>], cs[<span class="hljs-number">1</span>].z_range[<span class="hljs-number">1</span>]],
							});
						}
					}

					<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(merged_cuboid) = merged_cuboid {
						on_cuboids.<span class="hljs-title function_ invoke__">swap_remove</span>(j);
						on_cuboids.<span class="hljs-title function_ invoke__">swap_remove</span>(i);
						on_cuboids.<span class="hljs-title function_ invoke__">push</span>(merged_cuboid);
						<span class="hljs-keyword">continue</span> <span class="hljs-symbol">&#x27;merge</span>;
					}
				}
			}

			<span class="hljs-keyword">break</span>;
		}

		on_cuboids
	}
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_coords_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">coords</span> = s.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>);

		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">comps</span> = (<span class="hljs-number">0</span>..<span class="hljs-number">3</span>).<span class="hljs-title function_ invoke__">filter_map</span>(|_| {
			coords
				.<span class="hljs-title function_ invoke__">next</span>()?
				.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>)
				.<span class="hljs-title function_ invoke__">nth_back</span>(<span class="hljs-number">0</span>)?
				.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>)
				.<span class="hljs-title function_ invoke__">filter_map</span>(|splat| splat.<span class="hljs-title function_ invoke__">parse</span>().<span class="hljs-title function_ invoke__">ok</span>())
				.collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;()
				.<span class="hljs-title function_ invoke__">try_into</span>()
				.<span class="hljs-title function_ invoke__">ok</span>()
		});

		<span class="hljs-keyword">let</span> <span class="hljs-variable">x_range</span> = comps.<span class="hljs-title function_ invoke__">next</span>()?;
		<span class="hljs-keyword">let</span> <span class="hljs-variable">y_range</span> = comps.<span class="hljs-title function_ invoke__">next</span>()?;
		<span class="hljs-keyword">let</span> <span class="hljs-variable">z_range</span> = comps.<span class="hljs-title function_ invoke__">next</span>()?;

		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">Self</span> {
			x_range,
			y_range,
			z_range,
		})
	}
}

<span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> {
	On,
	Off,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">State</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">match</span> s {
			<span class="hljs-string">&quot;on&quot;</span> =&gt; <span class="hljs-keyword">Self</span>::On,
			<span class="hljs-string">&quot;off&quot;</span> =&gt; <span class="hljs-keyword">Self</span>::Off,
			_ =&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>,
		})
	}
}

<span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RebootStep</span> {
	state: State,
	cuboid: Cuboid,
}

<span class="hljs-comment">// tag::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Display</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RebootStep</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">fmt</span>(&amp;<span class="hljs-keyword">self</span>, f: &amp;<span class="hljs-keyword">mut</span> std::fmt::Formatter&lt;<span class="hljs-symbol">&#x27;_</span>&gt;) <span class="hljs-punctuation">-&gt;</span> std::fmt::<span class="hljs-type">Result</span> {
		f.<span class="hljs-title function_ invoke__">write_char</span>(<span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.state {
			State::On =&gt; <span class="hljs-string">&#x27;▲&#x27;</span>,
			State::Off =&gt; <span class="hljs-string">&#x27;▽&#x27;</span>,
		})?;
		f.<span class="hljs-title function_ invoke__">write_char</span>(<span class="hljs-string">&#x27; &#x27;</span>)?;

		<span class="hljs-keyword">let</span> <span class="hljs-variable">Cuboid</span> {
			x_range,
			y_range,
			z_range,
		} = &amp;<span class="hljs-keyword">self</span>.cuboid;
		<span class="hljs-built_in">write!</span>(f, <span class="hljs-string">&quot;{:?} {:?} {:?}&quot;</span>, x_range, y_range, z_range)
	}
}

<span class="hljs-comment">// end::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">RebootStep</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_line</span>(line: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">str_comps</span> = line.<span class="hljs-title function_ invoke__">split_ascii_whitespace</span>();
		<span class="hljs-keyword">let</span> <span class="hljs-variable">state</span> = State::<span class="hljs-title function_ invoke__">from_str</span>(str_comps.<span class="hljs-title function_ invoke__">next</span>()?)?;
		<span class="hljs-keyword">let</span> <span class="hljs-variable">cuboid</span> = Cuboid::<span class="hljs-title function_ invoke__">from_coords_str</span>(str_comps.<span class="hljs-title function_ invoke__">next</span>()?)?;
		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">Self</span> { state, cuboid })
	}
}

<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Grid</span> {
	on_cuboids: <span class="hljs-type">Vec</span>&lt;Cuboid&gt;,
	bounds: <span class="hljs-type">Option</span>&lt;Cuboid&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Grid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_with_size</span>(n: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
		Grid {
			on_cuboids: <span class="hljs-built_in">vec!</span>[],
			bounds: <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
				x_range: [-n, n],
				y_range: [-n, n],
				z_range: [-n, n],
			}),
		}
	}

	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_unbounded</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
		Grid {
			on_cuboids: <span class="hljs-built_in">vec!</span>[],
			bounds: <span class="hljs-literal">None</span>,
		}
	}

	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">apply_step</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, RebootStep { state, cuboid }: &amp;RebootStep) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;()&gt; {
		<span class="hljs-keyword">let</span> <span class="hljs-variable">cuboid</span> = <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(bounds) = <span class="hljs-keyword">self</span>.bounds {
			cuboid.<span class="hljs-title function_ invoke__">intersection</span>(&amp;bounds)?
		} <span class="hljs-keyword">else</span> {
			*cuboid
		};

		<span class="hljs-keyword">match</span> state {
			State::On =&gt; {
				<span class="hljs-keyword">self</span>.on_cuboids.<span class="hljs-title function_ invoke__">push</span>(cuboid);
			}
			State::Off =&gt; {
				<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">on_cuboids</span> = <span class="hljs-built_in">vec!</span>[];
				<span class="hljs-keyword">for</span> <span class="hljs-variable">my_cuboid</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">self</span>.on_cuboids {
					on_cuboids.<span class="hljs-title function_ invoke__">extend</span>(my_cuboid.<span class="hljs-title function_ invoke__">difference</span>(&amp;cuboid));
				}
				<span class="hljs-keyword">self</span>.on_cuboids = on_cuboids;
			}
		};

		<span class="hljs-title function_ invoke__">Some</span>(())
	}

	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">n_on</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">nonintersecting_cuboids</span> = <span class="hljs-built_in">vec!</span>[];
		<span class="hljs-title function_ invoke__">for</span> (i, &amp;c1) <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() {
			<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pieces</span> = <span class="hljs-built_in">vec!</span>[c1];
			<span class="hljs-keyword">for</span> &amp;c2 <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">skip</span>(i + <span class="hljs-number">1</span>) {
				pieces = pieces
					.<span class="hljs-title function_ invoke__">into_iter</span>()
					.<span class="hljs-title function_ invoke__">flat_map</span>(|piece| piece.<span class="hljs-title function_ invoke__">difference</span>(&amp;c2))
					.<span class="hljs-title function_ invoke__">collect</span>();
			}
			nonintersecting_cuboids.<span class="hljs-title function_ invoke__">extend</span>(pieces);
		}

		nonintersecting_cuboids
			.<span class="hljs-title function_ invoke__">iter</span>()
			.<span class="hljs-title function_ invoke__">fold</span>(<span class="hljs-number">0</span>, |accum, cuboid| accum + cuboid.<span class="hljs-title function_ invoke__">size</span>())
	}
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_input</span>(input: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;RebootStep&gt;&gt; {
	input
		.<span class="hljs-title function_ invoke__">lines</span>()
		.<span class="hljs-title function_ invoke__">map</span>(RebootStep::from_line)
		.collect::&lt;<span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;&gt;()
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">ans_for_input</span>(input: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> Answer&lt;<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>&gt; {
	<span class="hljs-keyword">let</span> <span class="hljs-variable">steps</span> = <span class="hljs-title function_ invoke__">read_input</span>(input).<span class="hljs-title function_ invoke__">unwrap</span>();
	(<span class="hljs-number">22</span>, (<span class="hljs-title function_ invoke__">pt1</span>(steps.<span class="hljs-title function_ invoke__">iter</span>()), <span class="hljs-title function_ invoke__">pt2</span>(steps.<span class="hljs-title function_ invoke__">iter</span>()))).<span class="hljs-title function_ invoke__">into</span>()
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ans</span>() <span class="hljs-punctuation">-&gt;</span> Answer&lt;<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>&gt; {
	<span class="hljs-title function_ invoke__">ans_for_input</span>(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;input.txt&quot;</span>))
}
<span class="hljs-comment">// end::setup[]</span>

<span class="hljs-comment">// tag::pt1[]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">pt1</span>&lt;R: std::borrow::Borrow&lt;RebootStep&gt;&gt;(steps: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span>&lt;Item = R&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
	<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">grid</span> = Grid::<span class="hljs-title function_ invoke__">new_with_size</span>(<span class="hljs-number">50</span>);
	<span class="hljs-keyword">for</span> <span class="hljs-variable">step</span> <span class="hljs-keyword">in</span> steps {
		grid.<span class="hljs-title function_ invoke__">apply_step</span>(step.<span class="hljs-title function_ invoke__">borrow</span>());
	}

	grid.<span class="hljs-title function_ invoke__">n_on</span>()
}

<span class="hljs-comment">// end::pt1[]</span>

<span class="hljs-comment">// tag::pt2[]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">pt2</span>&lt;R: std::borrow::Borrow&lt;RebootStep&gt;&gt;(steps: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span>&lt;Item = R&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
	<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">grid</span> = Grid::<span class="hljs-title function_ invoke__">new_unbounded</span>();
	<span class="hljs-keyword">for</span> <span class="hljs-variable">step</span> <span class="hljs-keyword">in</span> steps {
		grid.<span class="hljs-title function_ invoke__">apply_step</span>(step.<span class="hljs-title function_ invoke__">borrow</span>());
	}

	grid.<span class="hljs-title function_ invoke__">n_on</span>()
}
<span class="hljs-comment">// end::pt2[]</span>

<span class="hljs-meta">#[cfg(test)]</span>
<span class="hljs-keyword">mod</span> test {
	<span class="hljs-keyword">use</span> super::*;
	<span class="hljs-keyword">use</span> crate::test_input;

	<span class="hljs-meta">#[test]</span>
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">test</span>() {
		test_input!(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;input.txt&quot;</span>), day: <span class="hljs-number">22</span>, ans: (<span class="hljs-number">607_657</span>, <span class="hljs-number">1_187_742_789_778_677</span>));
	}
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parts_1_and_2"><a class="anchor" href="#_parts_1_and_2"></a>Parts 1 and 2</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Parts 1 and 2 ask us to perform the same sequence of operations.
In Part 1 this sequence occurs is in a bounded space (presumably in a space small enough for it to have been feasible to store each small cube individually).
In Part 2 this sequence occurs in an unbounded space, which is where the savings that come from doing cube intersections become important.</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-rust" data-lang="rust"><span class="hljs-comment">// tag::setup[]</span>
<span class="hljs-keyword">use</span> crate::Answer;
<span class="hljs-keyword">use</span> std::fmt::{Display, Write};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Span</span> = [<span class="hljs-type">i32</span>; <span class="hljs-number">2</span>];

<span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cuboid</span> {
	x_range: Span,
	y_range: Span,
	z_range: Span,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">size</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
		<span class="hljs-keyword">fn</span> <span class="hljs-title function_">width</span>(span: Span) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
			<span class="hljs-type">usize</span>::<span class="hljs-title function_ invoke__">try_from</span>(span[<span class="hljs-number">1</span>] - span[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>).<span class="hljs-title function_ invoke__">unwrap</span>()
		}
		<span class="hljs-keyword">let</span> &amp;Cuboid {
			x_range,
			y_range,
			z_range,
		} = <span class="hljs-keyword">self</span>;

		<span class="hljs-title function_ invoke__">width</span>(x_range) * <span class="hljs-title function_ invoke__">width</span>(y_range) * <span class="hljs-title function_ invoke__">width</span>(z_range)
	}
}

<span class="hljs-comment">// tag::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">std</span>::fmt::Display <span class="hljs-keyword">for</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">fmt</span>(&amp;<span class="hljs-keyword">self</span>, f: &amp;<span class="hljs-keyword">mut</span> std::fmt::Formatter&lt;<span class="hljs-symbol">&#x27;_</span>&gt;) <span class="hljs-punctuation">-&gt;</span> std::fmt::<span class="hljs-type">Result</span> {
		<span class="hljs-keyword">let</span> [x0, x1] = &amp;<span class="hljs-keyword">self</span>.x_range;
		<span class="hljs-keyword">let</span> [y0, y1] = &amp;<span class="hljs-keyword">self</span>.y_range;
		<span class="hljs-keyword">let</span> [z0, z1] = &amp;<span class="hljs-keyword">self</span>.z_range;
		<span class="hljs-built_in">write!</span>(f, <span class="hljs-string">&quot;{:?}-{:?},{:?}-{:?},{:?}-{:?}&quot;</span>, x0, x1, y0, y1, z0, z1)
	}
}

<span class="hljs-comment">// end::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">intersection</span>(&amp;<span class="hljs-keyword">self</span>, other: &amp;<span class="hljs-keyword">Self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">fn</span> <span class="hljs-title function_">span_intersection</span>(span1: Span, span2: Span) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;Span&gt; {
			<span class="hljs-keyword">let</span> <span class="hljs-variable">lower</span> = span1[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">max</span>(span2[<span class="hljs-number">0</span>]);
			<span class="hljs-keyword">let</span> <span class="hljs-variable">upper</span> = span1[<span class="hljs-number">1</span>].<span class="hljs-title function_ invoke__">min</span>(span2[<span class="hljs-number">1</span>]);
			<span class="hljs-keyword">if</span> upper &lt; lower {
				<span class="hljs-literal">None</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-title function_ invoke__">Some</span>([lower, upper])
			}
		}

		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">Self</span> {
			x_range: <span class="hljs-title function_ invoke__">span_intersection</span>(<span class="hljs-keyword">self</span>.x_range, other.x_range)?,
			y_range: <span class="hljs-title function_ invoke__">span_intersection</span>(<span class="hljs-keyword">self</span>.y_range, other.y_range)?,
			z_range: <span class="hljs-title function_ invoke__">span_intersection</span>(<span class="hljs-keyword">self</span>.z_range, other.z_range)?,
		})
	}

	<span class="hljs-comment">/// `other` divides `self` into 3^3 = 27 (potentially empty) sub-cuboids. Of the 26</span>
	<span class="hljs-comment">/// that aren&#x27;t `other`, we keep the nonempty ones. Once we&#x27;ve found them, we merge</span>
	<span class="hljs-comment">/// them into as large cuboids as possible.</span>
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">difference</span>(&amp;<span class="hljs-keyword">self</span>, other: &amp;<span class="hljs-keyword">Self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_spans</span>(my_span: Span, intersection_span: Span) <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-type">Option</span>&lt;Span&gt;; <span class="hljs-number">3</span>] {
			<span class="hljs-keyword">let</span> <span class="hljs-variable">span1</span> = <span class="hljs-keyword">if</span> my_span[<span class="hljs-number">0</span>] == intersection_span[<span class="hljs-number">0</span>] {
				<span class="hljs-literal">None</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-title function_ invoke__">Some</span>([my_span[<span class="hljs-number">0</span>], intersection_span[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>])
			};

			<span class="hljs-keyword">let</span> <span class="hljs-variable">span2</span> = <span class="hljs-title function_ invoke__">Some</span>(intersection_span);

			<span class="hljs-keyword">let</span> <span class="hljs-variable">span3</span> = <span class="hljs-keyword">if</span> intersection_span[<span class="hljs-number">1</span>] == my_span[<span class="hljs-number">1</span>] {
				<span class="hljs-literal">None</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-title function_ invoke__">Some</span>([intersection_span[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>, my_span[<span class="hljs-number">1</span>]])
			};

			[span1, span2, span3]
		}

		<span class="hljs-keyword">let</span> <span class="hljs-variable">intersection</span> = <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">intersection</span>(other) {
			<span class="hljs-title function_ invoke__">Some</span>(c) =&gt; c,
			<span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec!</span>[*<span class="hljs-keyword">self</span>],
		};

		<span class="hljs-keyword">let</span> <span class="hljs-variable">x_ranges</span> = <span class="hljs-title function_ invoke__">get_spans</span>(<span class="hljs-keyword">self</span>.x_range, intersection.x_range);
		<span class="hljs-keyword">let</span> <span class="hljs-variable">y_ranges</span> = <span class="hljs-title function_ invoke__">get_spans</span>(<span class="hljs-keyword">self</span>.y_range, intersection.y_range);
		<span class="hljs-keyword">let</span> <span class="hljs-variable">z_ranges</span> = <span class="hljs-title function_ invoke__">get_spans</span>(<span class="hljs-keyword">self</span>.z_range, intersection.z_range);

		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">on_cuboids</span> = <span class="hljs-type">Vec</span>::&lt;<span class="hljs-keyword">Self</span>&gt;::<span class="hljs-title function_ invoke__">new</span>();
		<span class="hljs-keyword">for</span> &amp;x_range <span class="hljs-keyword">in</span> x_ranges.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">flatten</span>() {
			<span class="hljs-keyword">for</span> &amp;y_range <span class="hljs-keyword">in</span> y_ranges.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">flatten</span>() {
				<span class="hljs-keyword">for</span> &amp;z_range <span class="hljs-keyword">in</span> z_ranges.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">flatten</span>() {
					<span class="hljs-keyword">if</span> x_range != intersection.x_range
						|| y_range != intersection.y_range
						|| z_range != intersection.z_range
					{
						on_cuboids.<span class="hljs-title function_ invoke__">push</span>(Cuboid {
							x_range,
							y_range,
							z_range,
						});
					}
				}
			}
		}

		<span class="hljs-comment">// Iteratively merge the split-up cuboids together, where possible. For instance,</span>
		<span class="hljs-comment">// if the middle of a cuboid was removed, there are 26 small cuboids created, but they</span>
		<span class="hljs-comment">// can be merged into six larger cuboids. This is done by looking for abutting</span>
		<span class="hljs-comment">// cuboids with the same dimensions along their respective abutting faces and</span>
		<span class="hljs-comment">// combining them into one cuboid.</span>
		<span class="hljs-symbol">&#x27;merge</span>: <span class="hljs-keyword">loop</span> {
			<span class="hljs-title function_ invoke__">for</span> (
				i,
				&amp;c1 @ Cuboid {
					x_range,
					y_range,
					z_range,
				},
			) <span class="hljs-keyword">in</span> on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>()
			{
				<span class="hljs-title function_ invoke__">for</span> (j, &amp;c2) <span class="hljs-keyword">in</span> on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>().<span class="hljs-title function_ invoke__">skip</span>(i + <span class="hljs-number">1</span>) {
					<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">cs</span> = [c1, c2];
					<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">merged_cuboid</span> = <span class="hljs-literal">None</span>;
					<span class="hljs-keyword">if</span> y_range == c2.y_range &amp;&amp; z_range == c2.z_range {
						cs.<span class="hljs-title function_ invoke__">sort_by_key</span>(|c| c.x_range);
						<span class="hljs-keyword">if</span> cs[<span class="hljs-number">0</span>].x_range[<span class="hljs-number">1</span>] == cs[<span class="hljs-number">1</span>].x_range[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span> {
							merged_cuboid = <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
								x_range: [cs[<span class="hljs-number">0</span>].x_range[<span class="hljs-number">0</span>], cs[<span class="hljs-number">1</span>].x_range[<span class="hljs-number">1</span>]],
								y_range,
								z_range,
							});
						}
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> x_range == c2.x_range &amp;&amp; z_range == c2.z_range {
						cs.<span class="hljs-title function_ invoke__">sort_by_key</span>(|c| c.y_range);
						<span class="hljs-keyword">if</span> cs[<span class="hljs-number">0</span>].y_range[<span class="hljs-number">1</span>] == cs[<span class="hljs-number">1</span>].y_range[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span> {
							merged_cuboid = <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
								x_range,
								y_range: [cs[<span class="hljs-number">0</span>].y_range[<span class="hljs-number">0</span>], cs[<span class="hljs-number">1</span>].y_range[<span class="hljs-number">1</span>]],
								z_range,
							});
						}
					} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> x_range == c2.x_range &amp;&amp; y_range == c2.y_range {
						cs.<span class="hljs-title function_ invoke__">sort_by_key</span>(|c| c.z_range);
						<span class="hljs-keyword">if</span> cs[<span class="hljs-number">0</span>].z_range[<span class="hljs-number">1</span>] == cs[<span class="hljs-number">1</span>].z_range[<span class="hljs-number">0</span>] - <span class="hljs-number">1</span> {
							merged_cuboid = <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
								x_range,
								y_range,
								z_range: [cs[<span class="hljs-number">0</span>].z_range[<span class="hljs-number">0</span>], cs[<span class="hljs-number">1</span>].z_range[<span class="hljs-number">1</span>]],
							});
						}
					}

					<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(merged_cuboid) = merged_cuboid {
						on_cuboids.<span class="hljs-title function_ invoke__">swap_remove</span>(j);
						on_cuboids.<span class="hljs-title function_ invoke__">swap_remove</span>(i);
						on_cuboids.<span class="hljs-title function_ invoke__">push</span>(merged_cuboid);
						<span class="hljs-keyword">continue</span> <span class="hljs-symbol">&#x27;merge</span>;
					}
				}
			}

			<span class="hljs-keyword">break</span>;
		}

		on_cuboids
	}
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Cuboid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_coords_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">coords</span> = s.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;,&#x27;</span>);

		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">comps</span> = (<span class="hljs-number">0</span>..<span class="hljs-number">3</span>).<span class="hljs-title function_ invoke__">filter_map</span>(|_| {
			coords
				.<span class="hljs-title function_ invoke__">next</span>()?
				.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>)
				.<span class="hljs-title function_ invoke__">nth_back</span>(<span class="hljs-number">0</span>)?
				.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>)
				.<span class="hljs-title function_ invoke__">filter_map</span>(|splat| splat.<span class="hljs-title function_ invoke__">parse</span>().<span class="hljs-title function_ invoke__">ok</span>())
				.collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;()
				.<span class="hljs-title function_ invoke__">try_into</span>()
				.<span class="hljs-title function_ invoke__">ok</span>()
		});

		<span class="hljs-keyword">let</span> <span class="hljs-variable">x_range</span> = comps.<span class="hljs-title function_ invoke__">next</span>()?;
		<span class="hljs-keyword">let</span> <span class="hljs-variable">y_range</span> = comps.<span class="hljs-title function_ invoke__">next</span>()?;
		<span class="hljs-keyword">let</span> <span class="hljs-variable">z_range</span> = comps.<span class="hljs-title function_ invoke__">next</span>()?;

		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">Self</span> {
			x_range,
			y_range,
			z_range,
		})
	}
}

<span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> {
	On,
	Off,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">State</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_str</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">match</span> s {
			<span class="hljs-string">&quot;on&quot;</span> =&gt; <span class="hljs-keyword">Self</span>::On,
			<span class="hljs-string">&quot;off&quot;</span> =&gt; <span class="hljs-keyword">Self</span>::Off,
			_ =&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>,
		})
	}
}

<span class="hljs-meta">#[derive(Debug, Clone, Copy)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RebootStep</span> {
	state: State,
	cuboid: Cuboid,
}

<span class="hljs-comment">// tag::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Display</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">RebootStep</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">fmt</span>(&amp;<span class="hljs-keyword">self</span>, f: &amp;<span class="hljs-keyword">mut</span> std::fmt::Formatter&lt;<span class="hljs-symbol">&#x27;_</span>&gt;) <span class="hljs-punctuation">-&gt;</span> std::fmt::<span class="hljs-type">Result</span> {
		f.<span class="hljs-title function_ invoke__">write_char</span>(<span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.state {
			State::On =&gt; <span class="hljs-string">&#x27;▲&#x27;</span>,
			State::Off =&gt; <span class="hljs-string">&#x27;▽&#x27;</span>,
		})?;
		f.<span class="hljs-title function_ invoke__">write_char</span>(<span class="hljs-string">&#x27; &#x27;</span>)?;

		<span class="hljs-keyword">let</span> <span class="hljs-variable">Cuboid</span> {
			x_range,
			y_range,
			z_range,
		} = &amp;<span class="hljs-keyword">self</span>.cuboid;
		<span class="hljs-built_in">write!</span>(f, <span class="hljs-string">&quot;{:?} {:?} {:?}&quot;</span>, x_range, y_range, z_range)
	}
}

<span class="hljs-comment">// end::debugging[]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">RebootStep</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_line</span>(line: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">str_comps</span> = line.<span class="hljs-title function_ invoke__">split_ascii_whitespace</span>();
		<span class="hljs-keyword">let</span> <span class="hljs-variable">state</span> = State::<span class="hljs-title function_ invoke__">from_str</span>(str_comps.<span class="hljs-title function_ invoke__">next</span>()?)?;
		<span class="hljs-keyword">let</span> <span class="hljs-variable">cuboid</span> = Cuboid::<span class="hljs-title function_ invoke__">from_coords_str</span>(str_comps.<span class="hljs-title function_ invoke__">next</span>()?)?;
		<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-keyword">Self</span> { state, cuboid })
	}
}

<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Grid</span> {
	on_cuboids: <span class="hljs-type">Vec</span>&lt;Cuboid&gt;,
	bounds: <span class="hljs-type">Option</span>&lt;Cuboid&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Grid</span> {
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_with_size</span>(n: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
		Grid {
			on_cuboids: <span class="hljs-built_in">vec!</span>[],
			bounds: <span class="hljs-title function_ invoke__">Some</span>(Cuboid {
				x_range: [-n, n],
				y_range: [-n, n],
				z_range: [-n, n],
			}),
		}
	}

	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">new_unbounded</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
		Grid {
			on_cuboids: <span class="hljs-built_in">vec!</span>[],
			bounds: <span class="hljs-literal">None</span>,
		}
	}

	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">apply_step</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, RebootStep { state, cuboid }: &amp;RebootStep) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;()&gt; {
		<span class="hljs-keyword">let</span> <span class="hljs-variable">cuboid</span> = <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(bounds) = <span class="hljs-keyword">self</span>.bounds {
			cuboid.<span class="hljs-title function_ invoke__">intersection</span>(&amp;bounds)?
		} <span class="hljs-keyword">else</span> {
			*cuboid
		};

		<span class="hljs-keyword">match</span> state {
			State::On =&gt; {
				<span class="hljs-keyword">self</span>.on_cuboids.<span class="hljs-title function_ invoke__">push</span>(cuboid);
			}
			State::Off =&gt; {
				<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">on_cuboids</span> = <span class="hljs-built_in">vec!</span>[];
				<span class="hljs-keyword">for</span> <span class="hljs-variable">my_cuboid</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">self</span>.on_cuboids {
					on_cuboids.<span class="hljs-title function_ invoke__">extend</span>(my_cuboid.<span class="hljs-title function_ invoke__">difference</span>(&amp;cuboid));
				}
				<span class="hljs-keyword">self</span>.on_cuboids = on_cuboids;
			}
		};

		<span class="hljs-title function_ invoke__">Some</span>(())
	}

	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">n_on</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
		<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">nonintersecting_cuboids</span> = <span class="hljs-built_in">vec!</span>[];
		<span class="hljs-title function_ invoke__">for</span> (i, &amp;c1) <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">enumerate</span>() {
			<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pieces</span> = <span class="hljs-built_in">vec!</span>[c1];
			<span class="hljs-keyword">for</span> &amp;c2 <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.on_cuboids.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">skip</span>(i + <span class="hljs-number">1</span>) {
				pieces = pieces
					.<span class="hljs-title function_ invoke__">into_iter</span>()
					.<span class="hljs-title function_ invoke__">flat_map</span>(|piece| piece.<span class="hljs-title function_ invoke__">difference</span>(&amp;c2))
					.<span class="hljs-title function_ invoke__">collect</span>();
			}
			nonintersecting_cuboids.<span class="hljs-title function_ invoke__">extend</span>(pieces);
		}

		nonintersecting_cuboids
			.<span class="hljs-title function_ invoke__">iter</span>()
			.<span class="hljs-title function_ invoke__">fold</span>(<span class="hljs-number">0</span>, |accum, cuboid| accum + cuboid.<span class="hljs-title function_ invoke__">size</span>())
	}
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">read_input</span>(input: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;RebootStep&gt;&gt; {
	input
		.<span class="hljs-title function_ invoke__">lines</span>()
		.<span class="hljs-title function_ invoke__">map</span>(RebootStep::from_line)
		.collect::&lt;<span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;&gt;()
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">ans_for_input</span>(input: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> Answer&lt;<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>&gt; {
	<span class="hljs-keyword">let</span> <span class="hljs-variable">steps</span> = <span class="hljs-title function_ invoke__">read_input</span>(input).<span class="hljs-title function_ invoke__">unwrap</span>();
	(<span class="hljs-number">22</span>, (<span class="hljs-title function_ invoke__">pt1</span>(steps.<span class="hljs-title function_ invoke__">iter</span>()), <span class="hljs-title function_ invoke__">pt2</span>(steps.<span class="hljs-title function_ invoke__">iter</span>()))).<span class="hljs-title function_ invoke__">into</span>()
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ans</span>() <span class="hljs-punctuation">-&gt;</span> Answer&lt;<span class="hljs-type">usize</span>, <span class="hljs-type">usize</span>&gt; {
	<span class="hljs-title function_ invoke__">ans_for_input</span>(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;input.txt&quot;</span>))
}
<span class="hljs-comment">// end::setup[]</span>

<span class="hljs-comment">// tag::pt1[]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">pt1</span>&lt;R: std::borrow::Borrow&lt;RebootStep&gt;&gt;(steps: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span>&lt;Item = R&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
	<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">grid</span> = Grid::<span class="hljs-title function_ invoke__">new_with_size</span>(<span class="hljs-number">50</span>);
	<span class="hljs-keyword">for</span> <span class="hljs-variable">step</span> <span class="hljs-keyword">in</span> steps {
		grid.<span class="hljs-title function_ invoke__">apply_step</span>(step.<span class="hljs-title function_ invoke__">borrow</span>());
	}

	grid.<span class="hljs-title function_ invoke__">n_on</span>()
}

<span class="hljs-comment">// end::pt1[]</span>

<span class="hljs-comment">// tag::pt2[]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">pt2</span>&lt;R: std::borrow::Borrow&lt;RebootStep&gt;&gt;(steps: <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Iterator</span>&lt;Item = R&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
	<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">grid</span> = Grid::<span class="hljs-title function_ invoke__">new_unbounded</span>();
	<span class="hljs-keyword">for</span> <span class="hljs-variable">step</span> <span class="hljs-keyword">in</span> steps {
		grid.<span class="hljs-title function_ invoke__">apply_step</span>(step.<span class="hljs-title function_ invoke__">borrow</span>());
	}

	grid.<span class="hljs-title function_ invoke__">n_on</span>()
}
<span class="hljs-comment">// end::pt2[]</span>

<span class="hljs-meta">#[cfg(test)]</span>
<span class="hljs-keyword">mod</span> test {
	<span class="hljs-keyword">use</span> super::*;
	<span class="hljs-keyword">use</span> crate::test_input;

	<span class="hljs-meta">#[test]</span>
	<span class="hljs-keyword">fn</span> <span class="hljs-title function_">test</span>() {
		test_input!(<span class="hljs-built_in">include_str!</span>(<span class="hljs-string">&quot;input.txt&quot;</span>), day: <span class="hljs-number">22</span>, ans: (<span class="hljs-number">607_657</span>, <span class="hljs-number">1_187_742_789_778_677</span>));
	}
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>     <nav class="pagination">
        <span class="prev"><a href="../day_21/soln">Day 21: Dirac Dice</a></span>
        <span class="next"><a href="../day_23/soln">Day 23: Amphipod</a></span>
    </nav>

</article>
  </div>
  <footer class="footer">
  <p>This page was built using <a href="https://antora.org" target="_blank">Antora</a> with a theme forked from the <a
      href="https://gitlab.com/antora/antora-ui-default" target="_blank">default UI</a>. Search is powered by <a
      href="https://lunrjs.com" target="_blank">Lunr</a>.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script>
	function add_is_current_path() {
		let elem = document.querySelector(`.nav-container .is-current-page > .final-depth`);
		if (!elem) { return; }
		while (!elem.classList.contains("nav-panel-explore")) {
			if (elem.tagName === "LI") {
				elem.classList.add("is-current-path");
			}
			elem = elem.parentNode;
		}
	}
	add_is_current_path()
</script>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
	<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
<script>
	function set_up_footnotes() {
		let footnoteBox;
		let footnoteP;
		const _isMobile = "ontouchstart" in document.documentElement;

		// Apparently, sticking the tooltip in a child div of document.body, instead of in
		// document.body directly, helps performance.
		// https://atfzl.com/don-t-attach-tooltips-to-document-body
		const footnoteHolder = document.createElement("div");
		document.body.appendChild(footnoteHolder);

		function showFootnoteBoxOnHover(elem) {
			const FOOTNOTE_BOX_MAX_WIDTH = 400;

			if (footnoteBox === undefined) {
				footnoteBox = document.createElement("div");
				footnoteHolder.appendChild(footnoteBox);
				footnoteBox.classList.add("footnote-box");
				footnoteBox.addEventListener("mouseleave", () => removeFootnoteBox());

				footnoteP = document.createElement("p");
				footnoteBox.appendChild(footnoteP);

				footnoteBox.style.zIndex = 9999;
			}

			// Remove the numbering from this footnote box
			const footnoteId = elem.getAttribute("href"); // Starts with #
			const footnoteClone = document
				.getElementById(footnoteId.substring(1))
				.cloneNode(true);
			const footnoteA = footnoteClone.getElementsByTagName("a")[0];
			footnoteA.remove();

			const footnoteHtml = footnoteClone.innerHTML.replace(/^\s*\.\s*/, "");

			footnoteP.innerHTML = footnoteHtml;
			footnoteBox.style.right = null;
			footnoteBox.style.left = "0px";
			footnoteBox.style.top = "0px";

			const elemRect = elem.getBoundingClientRect();
			const bodyRect = document.body.getBoundingClientRect();

			footnoteBox.style.display = "block";

			let tx = false;
			let ty = false;

			if (elemRect.left - FOOTNOTE_BOX_MAX_WIDTH < 10) {
				const px = -bodyRect.left + 10;
				footnoteBox.style.left = `${px}px`;

				tx = true;
			} else {
				const px = elemRect.left - bodyRect.left + 20;
				footnoteBox.style.left = `${px}px`;
			}

			const footnoteRect = footnoteBox.getBoundingClientRect();

			const windowHeight = document.documentElement.clientHeight;
			if (elemRect.top + footnoteRect.height > windowHeight) {
				const py = -10 + window.scrollY + windowHeight;
				footnoteBox.style.top = `${py}px`;
			} else {
				const py = elemRect.top - bodyRect.top;
				footnoteBox.style.top = `${py}px`;

				ty = true;
			}

			footnoteBox.style.transform = (() => {
				let transX = tx ? 0 : "-100%";
				let transY = ty ? 0 : "-100%";
				return `translate(${transX}, ${transY})`;
			})();

			// if (elemRect.right + FOOTNOTE_BOX_MAX_WIDTH - 30 > bodyRect.right) {
			// 	const px = bodyRect.right - (bodyRect.left + bodyRect.width);
			// 	console.log(bodyRect);
			// 	footnoteBox.style.left = null;
			// 	footnoteBox.style.right = `${px}px`;
			// 	console.log("right");
			// } else {
			// 	const px = -10 + elemRect.left - bodyRect.left;
			// 	footnoteBox.style.right = null;
			// 	footnoteBox.style.left = `${px}px`;
			// 	console.log("left");
			// }
		}

		function removeFootnoteBox() {
			if (footnoteBox === undefined) {
				return;
			}
			footnoteBox.style.display = "none";
		}

		function initializeFootnotes() {
			const footnotes = document.querySelectorAll(
				":not(#footnotes) .footnote a.footnote",
			);
			const nFootnotes = footnotes.length;
			for (let i = 0; i < nFootnotes; i++) {
				const footnote = footnotes[i];
				footnote.addEventListener("mouseenter", event => {
					showFootnoteBoxOnHover(footnote);
				});
			}
		}

		if (!_isMobile) {
			initializeFootnotes();
		}
	}
	set_up_footnotes()
</script>
<script>
	function add_titles() {
		const elems = document.querySelectorAll(".ui-icon.nav-menu-icon");
		for (let i = 0, len = elems.length; i < len; i++) {
			const elem = elems[i];
			if (elem.getAttribute('title') === null) {
				elems[i].setAttribute("title", "Navigation menu icon: one bullet followed by three sub-bullets");
			}
		}
	}
	add_titles()
</script>
</main>
</div>
</body>

</html>
